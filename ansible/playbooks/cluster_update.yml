- name: Update Docker-swarm Linux hosts
  hosts: docker_cluster
  gather_facts: true
  become: true
  become_user: root
  become_method: ansible.builtin.sudo
  serial: 1
  tasks:
    - name: Update package list
      ansible.builtin.command:
        cmd: dnf check-update -q
      register: needs_updates
      failed_when: needs_updates.rc == 10000
      changed_when: needs_updates.stdout | length > 0
      notify:
        - Upgrade system

    - name: Flush handlers
      ansible.builtin.meta: flush_handlers

    - name: Check for reboot required
      ansible.builtin.command:
        cmd: /bin/needs-restarting -r
      register: reboot_needed
      changed_when: '"Reboot should not be necessary." not in reboot_needed.stdout'
      failed_when: reboot_needed.rc == 10000
      notify:
        - Needs reboot

    - name: Wait for management port (tcp/9001) to become open on the host; don't start checking for 60 seconds
      ansible.builtin.wait_for:
        port: 9001
        delay: 60

  handlers:
    - name: Upgrade system
      ansible.builtin.dnf:
        state: latest
        name: '*'
      register: dnf_output

    - name: Needs reboot
      ansible.builtin.reboot:
        msg: 'WARNING: Host reboot to complete patching'
        connect_timeout: 180
